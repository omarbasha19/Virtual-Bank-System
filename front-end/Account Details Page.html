<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ejada - Account Overview</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f3fd;
      margin: 0;
      padding: 20px;
    }
    .container {
        max-width: 800px;
        margin: auto;
    }
    .header {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    .email {
      color: #555;
      margin-bottom: 20px;
    }
    .card {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .account-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: #4a6cf7;
    }
    .balance {
        font-size: 1.2rem;
        color: #28a745;
        font-weight: bold;
    }
    .details {
        display: none;
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .transaction {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    .transaction:last-child {
        border-bottom: none;
    }
    .transaction .amount {
        font-weight: bold;
    }
    .transaction .date {
        font-size: 0.8rem;
        color: #666;
    }
    .actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        background-color: #4a6cf7;
        color: white;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9rem;
        text-align: center;
        transition: background-color 0.3s;
    }
    .btn:hover {
        background-color: #3a5ada;
    }
    .btn-danger {
        background-color: #dc3545;
    }
    .btn-danger:hover {
        background-color: #c82333;
    }
    .welcome-card {
        background: linear-gradient(135deg, #4a6cf7, #6c5ce7);
        color: white;
        margin-bottom: 20px;
    }
    .account-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .summary-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a6cf7;
    }
    .summary-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
    }
    .info-note {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 6px 6px 0;
    }
    .info-note h4 {
        margin-top: 0;
        color: #1976d2;
    }
    .info-note p {
        margin-bottom: 0;
        color: #0d47a1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card welcome-card">
      <h1 class="header">Welcome, <span id="username-placeholder">John Doe</span>! ðŸŽ‰</h1>
      <p class="email" id="email-placeholder">john.doe@example.com</p>
    </div>

    <div class="info-note">
        <h4>ðŸ“‹ Account Information</h4>
        <p>Your account details and transaction history are displayed below. Use the transfer feature to send money between accounts.</p>
    </div>

    <div class="account-summary">
        <div class="summary-item">
            <div class="summary-value" id="total-balance">$12,450.75</div>
            <div class="summary-label">Total Balance</div>
        </div>
        <div class="summary-item">
            <div class="summary-value" id="account-count">3</div>
            <div class="summary-label">Active Accounts</div>
        </div>
        <div class="summary-item">
            <div class="summary-value" id="transaction-count">24</div>
            <div class="summary-label">Recent Transactions</div>
        </div>
    </div>
    
    <div class="actions">
        <a href="Ejada Transfer Page.html" class="btn">ðŸ’¸ Transfer Money</a>
        <button onclick="logout()" class="btn btn-danger">ðŸšª Logout</button>
    </div>

    <div id="accounts-container">
        <!-- Sample accounts will be populated here -->
    </div>
  </div>

  <script src="js/api-service.js"></script>
  <script src="js/dev-utils.js"></script>
  <script>
    // Will store the accounts data from API
    let userAccounts = [];
    let userTransactions = {};
    let userData = null;

    window.onload = function() {
        // Check if user is logged in with session validation
        if (!AuthUtils.requireAuth()) return;
        
        // Get user data
        userData = AuthUtils.getUserData();
        
        // Display user info
        document.getElementById('username-placeholder').textContent = `${userData.firstName || ''} ${userData.lastName || ''}`;
        document.getElementById('email-placeholder').textContent = userData.email || userData.username || '';
        
        // Load accounts data from API
        loadUserDashboard();
        
        // Extend session on activity
        AuthUtils.extendSession();
    };

    function loadUserDashboard() {
        // Show loading state
        document.getElementById('accounts-container').innerHTML = '<div class="card"><p>Loading your accounts...</p></div>';
        
        // Get user's dashboard data from BFF service
        BFFService.getDashboard(userData.id)
            .then(dashboardData => {
                // Store user accounts
                userAccounts = dashboardData.accounts || [];
                
                // Update summary data
                updateAccountSummary(dashboardData);
                
                // Display accounts
                loadAccounts();
                
                // Fetch transactions for each account if not included in dashboard data
                if (userAccounts.length > 0 && (!userAccounts[0].transactions || userAccounts[0].transactions.length === 0)) {
                    userAccounts.forEach(account => {
                        loadAccountTransactions(account.accountId || account.id);
                    });
                } else {
                    // If transactions are included in dashboard data, process them
                    userAccounts.forEach(account => {
                        userTransactions[account.accountId || account.id] = account.transactions || [];
                    });
                    
                    // Update transaction count
                    updateTransactionCount();
                }
            })
            .catch(error => {
                console.error('Error loading dashboard:', error);
                document.getElementById('accounts-container').innerHTML = 
                    `<div class="card" style="color: #dc3545">
                        <p>Error loading your accounts. Please try again later.</p>
                        <p>${error.message || ''}</p>
                    </div>`;
            });
    }
    
    function updateAccountSummary(dashboardData) {
        const accounts = dashboardData.accounts || [];
        
        // Calculate total balance
        const totalBalance = accounts.reduce((sum, account) => sum + parseFloat(account.balance || 0), 0);
        document.getElementById('total-balance').textContent = AuthUtils.formatCurrency(totalBalance);
        
        // Update account count
        document.getElementById('account-count').textContent = accounts.length;
        
        // Transaction count will be updated after loading transactions
        updateTransactionCount();
    }
    
    function updateTransactionCount() {
        // Calculate total transactions across all accounts
        const totalTransactions = Object.values(userTransactions)
            .reduce((count, txList) => count + (txList?.length || 0), 0);
        
        document.getElementById('transaction-count').textContent = totalTransactions;
    }
    
    function loadAccounts() {
        const container = document.getElementById('accounts-container');
        container.innerHTML = ''; // Clear container
        
        if (userAccounts.length === 0) {
            container.innerHTML = `
                <div class="card">
                    <p>You don't have any accounts yet.</p>
                    <a href="Create Account Page.html" class="btn">Create Your First Account</a>
                </div>`;
            return;
        }
        
        userAccounts.forEach(account => {
            container.appendChild(createAccountCard(account));
        });
    }
    
    function loadAccountTransactions(accountId) {
        TransactionService.getAccountTransactions(accountId)
            .then(transactions => {
                // Store transactions for this account
                userTransactions[accountId] = transactions;
                
                // Update transaction count
                updateTransactionCount();
                
                // Update the account card if it exists
                const accountCard = document.querySelector(`[data-account-id="${accountId}"]`);
                if (accountCard) {
                    const detailsDiv = accountCard.querySelector('.details');
                    updateTransactionDetails(detailsDiv, transactions);
                }
            })
            .catch(error => {
                console.error(`Error loading transactions for account ${accountId}:`, error);
                
                // Show error in the transactions area
                const accountCard = document.querySelector(`[data-account-id="${accountId}"]`);
                if (accountCard) {
                    const detailsDiv = accountCard.querySelector('.details');
                    detailsDiv.innerHTML = `
                        <h4>Recent Transactions</h4>
                        <p><em>Error loading transactions. Please try again later.</em></p>
                    `;
                }
            });
    }

    function createAccountCard(account) {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-account-id', account.accountId || account.id);
        
        // Determine account type based on account data
        const accountType = UIUtils.formatAccountType(account.accountType);
        
        // Format account number to show only last 4 digits
        const accountNumber = AuthUtils.formatAccountNumber(account.accountNumber);
        
        // Format balance
        const formattedBalance = AuthUtils.formatCurrency(parseFloat(account.balance));

        card.innerHTML = `
            <div class="account-title">${accountType}</div>
            <div><strong>Account Number:</strong> ${accountNumber}</div>
            <div class="balance">Balance: ${formattedBalance}</div>
            <button onclick="toggleDetails(this)" class="btn" style="margin-top: 15px;">View Transactions</button>
            <div class="details">
                <h4>Recent Transactions</h4>
                <p><em>Loading transactions...</em></p>
            </div>
        `;
        
        return card;
    }
    
    function updateTransactionDetails(detailsDiv, transactions) {
        if (!transactions || transactions.length === 0) {
            detailsDiv.innerHTML = `
                <h4>Recent Transactions</h4>
                <p><em>No recent transactions.</em></p>
            `;
            return;
        }
        
        const transactionsHtml = transactions.map(tx => `
            <div class="transaction">
                <div>
                    <strong>${tx.description || tx.transactionType || 'Transaction'}</strong><br>
                    <span class="date">${AuthUtils.formatDate(tx.timestamp)}</span>
                </div>
                <span class="amount" style="color: ${parseFloat(tx.amount) >= 0 ? '#28a745' : '#dc3545'};">
                    ${parseFloat(tx.amount) >= 0 ? '+' : ''}${AuthUtils.formatCurrency(Math.abs(parseFloat(tx.amount)))}
                </span>
            </div>
        `).join('');
        
        detailsDiv.innerHTML = `
            <h4>Recent Transactions</h4>
            ${transactionsHtml}
        `;
    }

    function toggleDetails(button) {
        const details = button.nextElementSibling;
        if (details.style.display === 'block') {
            details.style.display = 'none';
            button.textContent = 'View Transactions';
        } else {
            details.style.display = 'block';
            button.textContent = 'Hide Transactions';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            AuthUtils.clearUserData();
            window.location.href = 'Ejada Login Page.html';
        }
    }
  </script>
</body>
</html>
